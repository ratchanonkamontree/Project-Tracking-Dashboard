<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Tracker - Responsive UI</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Modern Variables */
        :root {
            --bg-body: #F8FAFC;
            --primary: #0F172A; /* Slate 900 */
            --accent: #3B82F6;  /* Blue 500 */
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: var(--bg-body);
            color: #334155;
            background-image: 
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.05) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.05) 0px, transparent 50%);
            background-attachment: fixed;
            overflow: hidden; /* Hide main scrollbar */
        }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #CBD5E1; border-radius: 10px; }
        
        /* Glass Effect */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* Nav Item */
        .nav-item {
            transition: all 0.2s ease;
            border-radius: 12px;
            color: #64748B;
            font-weight: 600;
            display: flex; align-items: center; gap: 12px;
            padding: 12px 16px;
        }
        .nav-item:hover { background-color: #F1F5F9; color: var(--primary); }
        .nav-item.active { background-color: var(--primary); color: white; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.15); }

        /* Excel Grid */
        .excel-table th { 
            background-color: #F8FAFC; color: #64748B; font-weight: 800; font-size: 0.65rem; 
            text-transform: uppercase; letter-spacing: 0.05em; padding: 14px 16px;
            border-bottom: 1px solid #E2E8F0; white-space: nowrap; position: sticky; top: 0; z-index: 10;
        }
        .excel-table td { 
            border-bottom: 1px solid #F1F5F9; padding: 12px 16px; font-size: 0.85rem; 
            background: white; white-space: nowrap; vertical-align: middle;
        }
        .excel-table tr:hover td { background-color: #F8FAFC; }

        /* Mobile Transition */
        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Card Hover */
        .hover-card { transition: transform 0.2s, box-shadow 0.2s; }
        .hover-card:active { transform: scale(0.98); }
        @media (min-width: 768px) {
            .hover-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        }
        
        /* Input Field */
        .modern-input {
            width: 100%; padding: 10px 14px; border-radius: 12px;
            background-color: #F8FAFC; border: 1px solid #E2E8F0;
            font-size: 0.9rem; transition: all 0.2s; outline: none;
        }
        .modern-input:focus { background-color: white; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body class="h-screen overflow-hidden">

    <!-- LOGIN OVERLAY -->
    <div id="login-screen" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-50/95 backdrop-blur-sm p-4">
        <div class="bg-white p-8 w-full max-w-sm rounded-3xl shadow-2xl border border-slate-100">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-slate-900 rounded-2xl flex items-center justify-center text-white text-3xl mx-auto shadow-lg mb-4">P</div>
                <h1 class="text-2xl font-bold text-slate-800">Welcome</h1>
                <p class="text-slate-400 text-sm mt-1">Sign in to Enterprise Tracker</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Username</label><input type="text" id="username" class="modern-input mt-1" placeholder="Enter Username" required></div>
                <div><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Password</label><input type="password" id="password" class="modern-input mt-1" placeholder="Enter Password" required></div>
                <button type="submit" class="w-full py-3.5 bg-slate-900 hover:bg-slate-800 text-white rounded-xl font-bold text-sm shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2">Sign In <i data-lucide="arrow-right" class="w-4 h-4"></i></button>
            </form>
        </div>
    </div>

    <!-- MAIN APP CONTAINER (Wrapper for Layout) -->
    <div id="app-container" class="h-full w-full flex flex-col md:flex-row overflow-hidden hidden">
        
        <!-- MOBILE HEADER -->
        <div class="md:hidden h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 z-40 shrink-0 shadow-sm">
            <button onclick="toggleSidebar(true)" class="p-2 -ml-2 text-slate-600 hover:bg-slate-50 rounded-xl active:bg-slate-100"><i data-lucide="menu" class="w-6 h-6"></i></button>
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center text-white text-sm font-bold">P</div>
                <span class="font-bold text-slate-800 text-lg">Tracker</span>
            </div>
            <div class="w-8"></div> <!-- Spacer for balance -->
        </div>

        <!-- SIDEBAR (Responsive Drawer) -->
        <!-- Overlay -->
        <div id="sidebar-overlay" onclick="toggleSidebar(false)" class="fixed inset-0 bg-slate-900/20 z-40 hidden md:hidden backdrop-blur-sm transition-opacity opacity-0"></div>
        
        <aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-[280px] bg-white border-r border-slate-200 z-50 transform -translate-x-full md:translate-x-0 sidebar-transition flex flex-col h-full shadow-2xl md:shadow-none">
            <div class="p-6 hidden md:flex items-center gap-3 mb-2">
                <div class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white text-xl font-bold shadow-md">P</div>
                <div><h1 class="font-bold text-slate-800 text-lg leading-none">Project</h1><p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-1">Manager</p></div>
            </div>

            <div class="p-4 md:hidden flex justify-between items-center border-b border-slate-100 bg-slate-50/50">
                <span class="font-bold text-slate-700 text-lg">Menu</span>
                <button onclick="toggleSidebar(false)" class="p-2 bg-white border border-slate-200 rounded-xl shadow-sm"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button>
            </div>

            <div class="px-6 py-2">
                <div id="status-badge" class="px-4 py-3 bg-slate-50 border border-slate-100 rounded-xl flex items-center gap-3">
                    <span class="relative flex h-2.5 w-2.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-slate-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-slate-300"></span></span>
                    <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Connecting...</span>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-1 overflow-y-auto custom-scrollbar mt-2 pb-4">
                <div class="text-[10px] font-extrabold text-slate-400 px-4 py-2 mt-2 uppercase tracking-widest">Main Menu</div>
                <button onclick="switchTab('dashboard'); toggleSidebar(false)" id="nav-dashboard" class="nav-item w-full"><i data-lucide="layout-grid" class="w-5 h-5"></i> Dashboard</button>
                <button onclick="switchTab('list'); filterByType(null); toggleSidebar(false)" id="nav-list" class="nav-item w-full"><i data-lucide="database" class="w-5 h-5"></i> Master Data</button>
                <button onclick="switchTab('add'); toggleSidebar(false)" id="nav-add" class="nav-item w-full"><i data-lucide="plus-circle" class="w-5 h-5"></i> New Entry</button>
                
                <div class="text-[10px] font-extrabold text-slate-400 px-4 py-2 mt-6 uppercase tracking-widest flex justify-between items-center">
                    <span>Workbooks</span> <i data-lucide="folder" class="w-3 h-3"></i>
                </div>
                <div id="project-nav-container" class="space-y-1"></div>
            </nav>

            <div class="p-4 border-t border-slate-100 bg-slate-50/30">
                <button onclick="fetchData(); toggleSidebar(false)" class="w-full flex items-center justify-center gap-2 bg-white border border-slate-200 hover:border-slate-300 text-slate-600 py-3 rounded-xl text-xs font-bold shadow-sm transition-all active:scale-95 mb-3 group"><i data-lucide="refresh-cw" class="w-4 h-4 group-hover:rotate-180 transition-transform"></i> Sync Data</button>
                <button onclick="logout()" class="w-full flex items-center justify-center gap-2 text-rose-500 hover:bg-rose-50 py-2.5 rounded-xl text-xs font-bold transition-all"><i data-lucide="log-out" class="w-4 h-4"></i> Sign Out</button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col h-full overflow-hidden relative w-full">
            
            <!-- Error Banner -->
            <div id="error-banner" class="hidden absolute top-4 left-1/2 transform -translate-x-1/2 z-50 w-[90%] max-w-lg mx-auto">
                <div class="bg-white border-l-4 border-rose-500 p-4 rounded-r-xl shadow-2xl flex items-start gap-3 animate-bounce-in">
                    <div class="text-rose-500 mt-0.5"><i data-lucide="alert-circle" class="w-5 h-5"></i></div>
                    <div class="flex-1">
                        <h3 class="text-sm font-bold text-slate-800">Connection Error</h3>
                        <p class="text-xs text-slate-500 mt-1" id="error-message">Failed to connect.</p>
                    </div>
                    <button onclick="fetchData()" class="px-3 py-1.5 bg-rose-50 text-rose-600 text-xs font-bold rounded-lg hover:bg-rose-100 transition-colors">Retry</button>
                    <button onclick="document.getElementById('error-banner').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>

            <!-- Scrollable Area -->
            <div class="flex-1 overflow-y-auto overflow-x-hidden p-4 md:p-6 lg:p-8 custom-scrollbar">
                
                <!-- Loading Spinner -->
                <div id="loading-indicator" class="hidden fixed bottom-6 right-6 bg-slate-900/90 backdrop-blur text-white px-5 py-3 rounded-full shadow-2xl flex items-center gap-3 z-50 animate-fade-in">
                    <div class="animate-spin w-4 h-4 border-2 border-white/30 border-t-white rounded-full"></div>
                    <span class="text-xs font-bold uppercase tracking-wide">Syncing...</span>
                </div>

                <!-- DASHBOARD VIEW -->
                <div id="view-dashboard" class="view-section hidden w-full max-w-[1920px] mx-auto pb-10">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4 mb-8">
                        <div>
                            <h2 class="text-3xl font-black text-slate-800 tracking-tight">Dashboard</h2>
                            <p class="text-slate-500 text-sm font-medium">Overview & Performance</p>
                        </div>
                        <div class="flex items-center gap-2 bg-white border border-slate-200 p-1.5 rounded-xl shadow-sm w-full sm:w-auto">
                            <div class="relative flex-1 sm:flex-none">
                                <i data-lucide="filter" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                                <select id="dash-filter" onchange="handleDashboardFilterChange(this.value)" class="appearance-none bg-transparent pl-10 pr-8 py-2 text-xs font-bold text-slate-600 outline-none cursor-pointer w-full"><option value="">All Projects</option></select>
                            </div>
                            <div class="bg-slate-100 px-3 py-2 rounded-lg text-xs font-bold text-slate-600"><span id="dash-total-count">0</span> Total</div>
                        </div>
                    </div>

                    <!-- KPI Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4 mb-8">
                        <!-- Cards with Pastel Accents -->
                        <div class="hover-card bg-white p-5 rounded-2xl border border-slate-100 shadow-sm relative overflow-hidden">
                            <div class="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4 opacity-50"></div>
                            <div class="relative z-10">
                                <div class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600 mb-4"><i data-lucide="layers" class="w-5 h-5"></i></div>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Total Projects</p>
                                <h3 id="stat-total" class="text-3xl font-black text-slate-800">0</h3>
                            </div>
                        </div>
                        
                        <div class="hover-card bg-white p-5 rounded-2xl border border-slate-100 shadow-sm relative overflow-hidden">
                             <div class="absolute right-0 top-0 w-24 h-24 bg-purple-50 rounded-bl-full -mr-4 -mt-4 opacity-50"></div>
                            <div class="relative z-10">
                                <div class="w-10 h-10 bg-purple-50 rounded-xl flex items-center justify-center text-purple-600 mb-4"><i data-lucide="wallet" class="w-5 h-5"></i></div>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Budget (PBOQ)</p>
                                <h3 id="stat-budget" class="text-2xl font-black text-slate-800 truncate">฿0</h3>
                            </div>
                        </div>

                        <div class="hover-card bg-white p-5 rounded-2xl border border-slate-100 shadow-sm relative overflow-hidden">
                             <div class="absolute right-0 top-0 w-24 h-24 bg-pink-50 rounded-bl-full -mr-4 -mt-4 opacity-50"></div>
                            <div class="relative z-10">
                                <div class="w-10 h-10 bg-pink-50 rounded-xl flex items-center justify-center text-pink-600 mb-4"><i data-lucide="banknote" class="w-5 h-5"></i></div>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Actual (FBOQ)</p>
                                <h3 id="stat-fboq" class="text-2xl font-black text-slate-800 truncate">฿0</h3>
                            </div>
                        </div>

                        <div class="hover-card bg-white p-5 rounded-2xl border border-slate-100 shadow-sm relative overflow-hidden">
                             <div class="absolute right-0 top-0 w-24 h-24 bg-emerald-50 rounded-bl-full -mr-4 -mt-4 opacity-50"></div>
                            <div class="relative z-10">
                                <div class="w-10 h-10 bg-emerald-50 rounded-xl flex items-center justify-center text-emerald-600 mb-4"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Delivered</p>
                                <h3 id="stat-completed" class="text-3xl font-black text-slate-800">0</h3>
                            </div>
                        </div>

                        <div class="hover-card bg-white p-5 rounded-2xl border border-slate-100 shadow-sm relative overflow-hidden sm:col-span-2 lg:col-span-1">
                             <div class="absolute right-0 top-0 w-24 h-24 bg-orange-50 rounded-bl-full -mr-4 -mt-4 opacity-50"></div>
                            <div class="relative z-10">
                                <div class="w-10 h-10 bg-orange-50 rounded-xl flex items-center justify-center text-orange-600 mb-4"><i data-lucide="activity" class="w-5 h-5"></i></div>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">In Progress</p>
                                <h3 id="stat-active" class="text-3xl font-black text-slate-800">0</h3>
                            </div>
                        </div>
                    </div>

                    <!-- Main Grid -->
                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                        <!-- Project Breakdown (Wide) -->
                        <div class="xl:col-span-2 space-y-4">
                            <div class="flex justify-between items-center">
                                 <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2 uppercase tracking-wider"><i data-lucide="layout-list" class="w-4 h-4 text-slate-400"></i> Project Breakdown</h3>
                            </div>
                            <div id="project-cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        </div>
                        
                        <!-- Charts (Side) -->
                        <div class="xl:col-span-1 space-y-4">
                            <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2 uppercase tracking-wider"><i data-lucide="globe" class="w-4 h-4 text-slate-400"></i> Regional Load</h3>
                            <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex items-center justify-center min-h-[350px]">
                                <canvas id="regionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LIST VIEW -->
                <div id="view-list" class="view-section hidden h-full flex flex-col w-full">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white shadow-lg"><i data-lucide="table" class="w-5 h-5"></i></div>
                            <div><h2 class="text-xl font-bold text-slate-800" id="list-title">Master Data</h2><p class="text-xs text-slate-400 font-medium">Detailed database records</p></div>
                        </div>
                        <div class="relative w-full sm:w-72">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                            <input type="text" id="search-input" onkeyup="renderTable()" placeholder="Search anything..." class="w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm focus:border-slate-400 outline-none shadow-sm transition-all">
                        </div>
                    </div>

                    <!-- Summary Bar (Scrollable on mobile) -->
                    <div class="flex gap-3 mb-6 overflow-x-auto custom-scrollbar pb-2">
                        <div class="bg-white px-5 py-3 rounded-xl border border-slate-200 shadow-sm min-w-[120px] flex-1"><span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Total Projects</span><div class="text-xl font-black text-slate-800 mt-1" id="sheet-total-count">0</div></div>
                        <div class="bg-white px-5 py-3 rounded-xl border border-slate-200 shadow-sm min-w-[120px] flex-1"><span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Work Orders</span><div class="text-xl font-black text-slate-800 mt-1" id="sheet-wo-count">0</div></div>
                        <div class="bg-white px-5 py-3 rounded-xl border border-slate-200 shadow-sm min-w-[140px] flex-1 border-l-4 border-l-purple-400"><span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Budget (PBOQ)</span><div class="text-xl font-black text-purple-600 mt-1 truncate" id="sheet-pboq">฿0</div></div>
                        <div class="bg-white px-5 py-3 rounded-xl border border-slate-200 shadow-sm min-w-[140px] flex-1 border-l-4 border-l-pink-400"><span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Actual (FBOQ)</span><div class="text-xl font-black text-pink-600 mt-1 truncate" id="sheet-fboq">฿0</div></div>
                    </div>

                    <!-- Status Pills -->
                    <div id="sheet-status-breakdown-container" class="hidden mb-4">
                        <div class="flex gap-2 overflow-x-auto custom-scrollbar pb-2" id="sheet-status-breakdown"></div>
                    </div>

                    <!-- Table -->
                    <div class="flex-1 bg-white border border-slate-200 rounded-2xl overflow-hidden flex flex-col shadow-sm">
                        <div class="overflow-auto flex-1 custom-scrollbar">
                            <table class="w-full excel-table text-left">
                                <thead class="bg-slate-50 sticky top-0 z-10"><tr id="table-header-row"></tr></thead>
                                <tbody id="table-body" class="divide-y divide-slate-100 text-slate-600"></tbody>
                            </table>
                        </div>
                        <div class="p-3 border-t border-slate-100 bg-slate-50 flex justify-between items-center px-5">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1"><i data-lucide="eye" class="w-3 h-3"></i> View Only Mode</span>
                            <span class="text-[10px] font-bold text-slate-500 bg-white px-2 py-1 rounded border border-slate-200" id="row-count">0 Rows</span>
                        </div>
                    </div>
                </div>

                <!-- ADD VIEW -->
                <div id="view-add" class="view-section hidden max-w-3xl mx-auto pb-10">
                    <div class="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-slate-200">
                        <div class="flex items-center gap-4 mb-8 pb-4 border-b border-slate-100">
                            <div class="bg-slate-900 p-3 rounded-xl text-white shadow-lg"><i data-lucide="file-plus-2" class="w-6 h-6"></i></div>
                            <div><h2 class="text-2xl font-black text-slate-800">New Entry</h2><p class="text-slate-400 text-sm font-medium">Create a new project record</p></div>
                        </div>
                        <form id="add-form" class="grid grid-cols-12 gap-5" onsubmit="handleFormSubmit(event)">
                            <div class="col-span-12 md:col-span-4"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">CCT NO (Auto)</label><input id="input-cct" readonly class="modern-input mt-1 bg-slate-100 text-slate-400 cursor-not-allowed border-transparent"></div>
                            <div class="col-span-6 md:col-span-4"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Year</label><div class="relative mt-1"><select id="input-year" class="modern-input appearance-none cursor-pointer"></select><i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i></div></div>
                            <div class="col-span-6 md:col-span-4"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Type</label><div class="relative mt-1"><select id="input-type" class="modern-input appearance-none cursor-pointer"></select><i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i></div></div>
                            
                            <div class="col-span-12"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Project Name</label><input id="input-name" required class="modern-input mt-1" placeholder="Enter full project name..."></div>
                            
                            <div class="col-span-12 md:col-span-6"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Region</label><div class="relative mt-1"><input id="input-region" list="regions-list" class="modern-input" placeholder="Select or type..."><i data-lucide="map-pin" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i></div><datalist id="regions-list"><option value="NOE1"><option value="NOE2"><option value="EAST"><option value="NOE"></datalist></div>
                            <div class="col-span-12 md:col-span-6"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Status</label><div class="relative mt-1"><select id="input-status" class="modern-input appearance-none cursor-pointer"></select><i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i></div></div>
                            
                            <div class="col-span-12 my-2 border-t border-slate-100"></div>

                            <div class="col-span-6 md:col-span-3"><label class="text-[10px] font-bold text-purple-400 uppercase tracking-widest ml-1">PBOQ</label><input type="number" id="input-pboq" class="modern-input mt-1 text-purple-600 font-bold font-mono"></div>
                            <div class="col-span-6 md:col-span-3"><label class="text-[10px] font-bold text-pink-400 uppercase tracking-widest ml-1">FBOQ</label><input type="number" id="input-fboq" class="modern-input mt-1 text-pink-600 font-bold font-mono"></div>
                            <div class="col-span-6 md:col-span-3"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">WO</label><input id="input-wo" class="modern-input mt-1"></div>
                            <div class="col-span-6 md:col-span-3"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">PO</label><input id="input-po" class="modern-input mt-1"></div>

                            <div class="col-span-12 mt-6 flex justify-end gap-3">
                                <button type="button" onclick="switchTab('list')" class="px-6 py-3 text-slate-500 hover:bg-slate-100 rounded-xl text-xs font-bold transition-colors">Cancel</button>
                                <button type="submit" class="px-8 py-3 bg-slate-900 hover:bg-slate-800 text-white rounded-xl text-xs font-bold shadow-lg shadow-slate-200 transition-all active:scale-95 flex items-center gap-2"><i data-lucide="save" class="w-4 h-4"></i> Save Record</button>
                            </div>
                        </form>
                   </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL (Responsive Stack) -->
    <div id="project-modal" class="fixed inset-0 z-[80] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeProjectModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-2 md:p-4">
                <div class="bg-white w-full max-w-7xl rounded-2xl shadow-2xl overflow-hidden scale-in flex flex-col max-h-[95vh] border border-slate-200">
                    <!-- Modal Header -->
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-20">
                        <div><h3 class="text-xl font-black text-slate-800" id="modal-title">Project</h3><p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mt-0.5">Details Overview</p></div>
                        <button onclick="closeProjectModal()" class="p-2 rounded-full hover:bg-slate-100 text-slate-400 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    
                    <!-- Modal Content -->
                    <div class="p-4 md:p-6 bg-[#F8FAFC] overflow-y-auto custom-scrollbar">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="modal-stats"></div>
                        
                        <div class="flex flex-col lg:flex-row gap-6 h-auto lg:h-[600px]">
                            <!-- Left: Status List -->
                            <div class="lg:w-1/3 bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex flex-col h-[400px] lg:h-full">
                                <h4 class="text-[10px] font-extrabold text-slate-400 mb-4 uppercase tracking-widest border-b border-slate-50 pb-2">Status Breakdown</h4>
                                <div class="space-y-1.5 overflow-y-auto custom-scrollbar flex-1 pr-2" id="modal-status-bars"></div>
                            </div>
                            
                            <!-- Right: Table -->
                            <div class="lg:w-2/3 bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col overflow-hidden h-[500px] lg:h-full">
                                <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-white">
                                    <h4 class="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest">Entry List</h4>
                                    <select id="modal-status-filter" onchange="filterModalTable()" class="bg-slate-50 border border-slate-200 text-slate-600 text-[10px] font-bold rounded-lg px-3 py-1.5 outline-none cursor-pointer hover:bg-slate-100 transition-colors">
                                        <option value="">All Statuses</option>
                                    </select>
                                </div>
                                <div class="flex-1 overflow-hidden relative">
                                    <div class="absolute inset-0 overflow-y-auto custom-scrollbar">
                                        <table class="w-full text-left excel-table">
                                            <thead class="bg-slate-50 sticky top-0 z-10 shadow-sm">
                                                <tr>
                                                    <th class="w-24">CCT</th>
                                                    <th>Name</th>
                                                    <th class="text-center w-16">Drive</th>
                                                    <th class="text-right w-32">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody class="text-sm text-slate-600 divide-y divide-slate-100" id="modal-table-body"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const API_URL = "https://script.google.com/macros/s/AKfycbxqxgoM15CIhJTF5Uk3CHB1Fkpd6zkKaVbmhtXuDr3aHAgT0Ux7v_L407anOpSeFUfd/exec"; 
        const APP_USERNAME = "AdminCCT"; 
        const APP_PASSWORD = "CCT12345";
        
        const PROJECT_TYPES = ["RAUG", "IMPROVE", "Closeloop", "MOBILE", "Online", "Event", "Battery", "CM Site"];
        const STATUS_OPTIONS = ["Assign", "Wait Survey", "Surveyed", "Wait GATE", "GATE REJECT", "PASS GATE", "Lay OFC", "Wait CUT OFC", "Wait PAT", "Cancel", "Completed", "RE GATE"];
        const STATUS_COLORS = { 
            'Completed': '#10B981', 'Assign': '#64748B', 'Wait Survey': '#F59E0B', 'Surveyed': '#D97706', 
            'Wait GATE': '#8B5CF6', 'GATE REJECT': '#EF4444', 'PASS GATE': '#3B82F6', 'Lay OFC': '#0EA5E9', 
            'Wait CUT OFC': '#6366F1', 'Wait PAT': '#EC4899', 'Cancel': '#94A3B8', 'RE GATE': '#F43F5E' 
        };

        // COLUMNS
        let tableColumns = [
            { key: 'cctNo', label: 'CCT No', width: '100px' },
            { key: 'year', label: 'Year', width: '60px' },
            { key: 'subRegion', label: 'Region', width: '80px' },
            { key: 'googleDrive', label: 'Drive', width: '60px', type: 'link' },
            { key: 'project', label: 'Project', width: '90px' },
            { key: 'projectName', label: 'Project Name', width: '220px' },
            { key: 'lastStatus', label: 'Status', width: '110px', type: 'status' },
            { key: 'workOrder', label: 'WO', width: '90px' },
            { key: 'poNo', label: 'PO', width: '90px' },
            { key: 'pboq', label: 'PBOQ', width: '90px', type: 'number' },
            { key: 'fboq', label: 'FBOQ', width: '90px', type: 'number' }
        ];

        let globalData = [];
        let currentFilterType = null;
        let dashboardFilterType = "";
        let charts = { region: null };
        let currentModalProjectType = null;

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initSidebar();
            initFormDropdowns();
            initDashboardFilter();
            checkSession();
            // Handle mobile menu overlay click
            document.getElementById('sidebar-overlay').addEventListener('click', () => toggleSidebar(false));
        });

        // AUTH & UI
        function checkSession() {
            const isLog = localStorage.getItem('isLoggedIn') === 'true';
            document.getElementById('login-screen').classList.toggle('hidden', isLog);
            document.getElementById('app-container').classList.toggle('hidden', !isLog);
            if(isLog) { switchTab('dashboard'); fetchData(); }
        }
        
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if(document.getElementById('username').value === APP_USERNAME && document.getElementById('password').value === APP_PASSWORD) {
                localStorage.setItem('isLoggedIn', 'true'); checkSession();
            } else alert('Invalid Credentials');
        });
        
        function logout() { localStorage.removeItem('isLoggedIn'); location.reload(); }
        
        function toggleSidebar(force) {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebar-overlay');
            const isHidden = sb.classList.contains('-translate-x-full');
            const show = force !== undefined ? force : isHidden;
            
            if(show) {
                sb.classList.remove('-translate-x-full');
                ov.classList.remove('hidden');
                setTimeout(() => ov.classList.remove('opacity-0'), 10);
            } else {
                sb.classList.add('-translate-x-full');
                ov.classList.add('opacity-0');
                setTimeout(() => ov.classList.add('hidden'), 300);
            }
        }

        // DATA LOGIC
        function normalizeData(raw) {
            return raw.map((item, idx) => ({
                id: item.id || Date.now() + idx,
                cctNo: (item.cctNo || '').toString().trim(),
                year: (item.year || '').toString().trim(),
                project: (item.project || '').toString().trim(),
                projectName: (item.projectName || '').toString().trim(),
                subRegion: (item.subRegion || '').toString().trim(),
                lastStatus: (item.lastStatus || '').toString().trim(),
                pboq: item.pboq || 0,
                fboq: item.fboq || 0,
                workOrder: (item.workOrder || '').toString().trim(),
                poNo: (item.poNo || '').toString().trim(),
                googleDrive: (item.googleDrive || '').toString().trim()
            }));
        }

        async function fetchData() {
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('status-badge').className = "px-4 py-3 bg-amber-50 border border-amber-100 rounded-xl flex items-center gap-3";
            document.getElementById('status-badge').innerHTML = `<span class="relative flex h-2.5 w-2.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-amber-500"></span></span><span class="text-[10px] font-bold text-amber-600 uppercase tracking-wider">Connecting...</span>`;
            document.getElementById('error-banner').classList.add('hidden');

            try {
                const res = await fetch(`${API_URL}?action=read&t=${Date.now()}`, { method: "GET", redirect: "follow", headers: { "Content-Type": "text/plain;charset=utf-8" } });
                if (!res.ok) throw new Error("HTTP " + res.status);
                const json = await res.json();
                if(Array.isArray(json)) { 
                    globalData = normalizeData(json); renderTable(); updateStats(); 
                    document.getElementById('status-badge').className = "px-4 py-3 bg-emerald-50 border border-emerald-100 rounded-xl flex items-center gap-3";
                    document.getElementById('status-badge').innerHTML = `<span class="relative flex h-2.5 w-2.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500"></span></span><span class="text-[10px] font-bold text-emerald-600 uppercase tracking-wider">System Online</span>`;
                } else throw new Error("Invalid Data");
            } catch(e) { 
                console.error(e);
                document.getElementById('error-message').innerText = e.message;
                document.getElementById('error-banner').classList.remove('hidden');
                document.getElementById('status-badge').className = "px-4 py-3 bg-rose-50 border border-rose-100 rounded-xl flex items-center gap-3";
                document.getElementById('status-badge').innerHTML = `<span class="relative flex h-2.5 w-2.5"><span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-rose-500"></span></span><span class="text-[10px] font-bold text-rose-600 uppercase tracking-wider">Offline</span>`;
            } finally { document.getElementById('loading-indicator').classList.add('hidden'); }
        }

        // DASHBOARD
        function getDashboardData() { return dashboardFilterType ? globalData.filter(d => (d.project||'').toLowerCase() === dashboardFilterType.toLowerCase()) : globalData; }
        function initDashboardFilter() { const s = document.getElementById('dash-filter'); PROJECT_TYPES.forEach(t => s.add(new Option(t,t))); }
        function handleDashboardFilterChange(v) { dashboardFilterType = v; updateStats(); }

        function updateStats() {
            const data = getDashboardData();
            const completed = data.filter(d => (d.lastStatus||'').toLowerCase() === 'completed').length;
            const pboq = data.reduce((s,d)=>s+(parseFloat(d.pboq)||0),0);
            const fboq = data.reduce((s,d)=>s+(parseFloat(d.fboq)||0),0);
            
            document.getElementById('stat-total').innerText = data.length;
            document.getElementById('stat-budget').innerText = `฿${formatCurrency(pboq)}`;
            document.getElementById('stat-fboq').innerText = `฿${formatCurrency(fboq)}`;
            document.getElementById('stat-completed').innerText = completed;
            document.getElementById('stat-active').innerText = data.length - completed;
            
            renderCharts(data);
        }

        function renderCharts(data) {
            const container = document.getElementById('project-cards-container'); container.innerHTML = '';
            const types = dashboardFilterType ? [dashboardFilterType] : PROJECT_TYPES;
            
            types.forEach(t => {
                const tData = globalData.filter(d => (d.project||'').toLowerCase() === t.toLowerCase());
                const total = tData.length;
                const done = tData.filter(d => (d.lastStatus||'').toLowerCase() === 'completed').length;
                const pct = total ? Math.round((done/total)*100) : 0;
                
                // Status Breakdown
                const statusCounts = {};
                tData.forEach(d => { 
                    let st = d.lastStatus || 'Unknown';
                    const match = STATUS_OPTIONS.find(opt => opt.toLowerCase() === st.toLowerCase());
                    if(match) st = match;
                    statusCounts[st] = (statusCounts[st] || 0) + 1; 
                });
                
                const activeStatuses = Object.keys(statusCounts).filter(s => statusCounts[s] > 0).sort((a,b) => statusCounts[b] - statusCounts[a]);
                
                let statusListHTML = activeStatuses.length === 0 ? '<div class="text-xs text-slate-400 italic py-4 text-center">No active projects</div>' :
                    activeStatuses.map(s => {
                         const colorKey = Object.keys(STATUS_COLORS).find(k => k.toLowerCase() === s.toLowerCase());
                         const color = STATUS_COLORS[s] || STATUS_COLORS[colorKey] || '#64748B';
                         const count = statusCounts[s];
                         const barPct = total ? Math.round((count/total)*100) : 0;
                         return `
                            <div class="flex flex-col gap-1 mb-2">
                                <div class="flex justify-between text-[10px] font-bold text-slate-500 uppercase tracking-wide">
                                    <span>${s}</span>
                                    <span class="bg-slate-100 text-slate-600 px-1.5 rounded">${count}</span>
                                </div>
                                <div class="h-1.5 w-full bg-slate-50 rounded-full overflow-hidden border border-slate-100">
                                    <div class="h-full rounded-full transition-all duration-500" style="width: ${barPct}%; background-color: ${color}"></div>
                                </div>
                            </div>
                         `;
                    }).join('');

                container.innerHTML += `
                    <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:-translate-y-1 transition-transform cursor-pointer h-full flex flex-col group" onclick="openProjectModal('${t}')">
                        <div class="flex justify-between items-center mb-4 pb-3 border-b border-slate-50">
                            <h4 class="font-bold text-slate-700 flex items-center gap-2 group-hover:text-blue-600 transition-colors">
                                <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-slate-500 group-hover:bg-blue-50 group-hover:text-blue-500"><i data-lucide="folder" class="w-4 h-4"></i></div> ${t}
                            </h4>
                            <div class="flex flex-col items-end">
                                <span class="text-xs font-black text-slate-700">${total}</span>
                                <span class="text-[9px] font-bold text-emerald-500 uppercase tracking-wide">${pct}% Done</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                             <div class="bg-purple-50 p-2 rounded-lg border border-purple-100"><p class="text-[9px] text-purple-400 font-bold uppercase">PBOQ</p><p class="text-xs font-black text-purple-700 truncate">฿${formatCurrency(tData.reduce((s,d)=>s+(parseFloat(d.pboq)||0),0))}</p></div>
                             <div class="bg-pink-50 p-2 rounded-lg border border-pink-100"><p class="text-[9px] text-pink-400 font-bold uppercase">FBOQ</p><p class="text-xs font-black text-pink-700 truncate">฿${formatCurrency(tData.reduce((s,d)=>s+(parseFloat(d.fboq)||0),0))}</p></div>
                        </div>
                        <div class="flex-1 space-y-1 overflow-y-auto custom-scrollbar pr-1 max-h-48">${statusListHTML}</div>
                    </div>
                `;
            });

            // Region Chart
            if(charts.region) charts.region.destroy();
            const regionCanvas = document.getElementById('regionChart');
            if(regionCanvas && regionCanvas.offsetParent) {
                const rCounts = {}; data.forEach(d => { if(d.subRegion) rCounts[d.subRegion] = (rCounts[d.subRegion]||0)+1; });
                charts.region = new Chart(regionCanvas, {
                    type: 'doughnut',
                    data: { 
                        labels: Object.keys(rCounts), 
                        datasets: [{ 
                            data: Object.values(rCounts), 
                            backgroundColor: ['#3B82F6','#8B5CF6','#EC4899','#10B981','#F59E0B'],
                            borderWidth: 0, hoverOffset: 4 
                        }] 
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false, 
                        plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: { family: "'Outfit', sans-serif", size: 10 }, padding: 20 } } },
                        cutout: '75%', layout: { padding: 10 }
                    }
                });
            }
            lucide.createIcons();
        }

        // LIST VIEW
        function renderTable() {
            const tbody = document.getElementById('table-body');
            const thead = document.getElementById('table-header-row');
            tbody.innerHTML = ''; thead.innerHTML = '';
            
            tableColumns.filter(c => !currentFilterType || c.key !== 'project').forEach(col => {
                thead.innerHTML += `<th style="min-width:${col.width}">${col.label}</th>`;
            });
            
            const search = document.getElementById('search-input').value.toLowerCase();
            const filteredData = globalData.filter(d => (!currentFilterType || d.project.toLowerCase() === currentFilterType.toLowerCase()) && (!search || JSON.stringify(d).toLowerCase().includes(search)));
            
            document.getElementById('row-count').innerText = `${filteredData.length} Rows`;
            updateSheetStats(filteredData);

            if (filteredData.length === 0) { tbody.innerHTML = `<tr><td colspan="10" class="text-center py-12 text-slate-400 italic">No matching records found</td></tr>`; return; }
            
            filteredData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "group hover:bg-slate-50 transition-colors";
                tableColumns.filter(c => !currentFilterType || c.key !== 'project').forEach(col => {
                    let html = item[col.key];
                    if (col.type === 'link') {
                        html = item[col.key].startsWith('http') ? `<a href="${item[col.key]}" target="_blank" class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition-colors"><i data-lucide="folder" class="w-4 h-4"></i></a>` : '<span class="text-slate-300">-</span>';
                    } else if (col.type === 'status') {
                        const colorKey = Object.keys(STATUS_COLORS).find(k => k.toLowerCase() === item[col.key].toLowerCase());
                        const color = STATUS_COLORS[item[col.key]] || STATUS_COLORS[colorKey] || '#64748B';
                        html = `<span class="px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider border" style="color:${color}; background-color:${color}10; border-color:${color}20">${item[col.key]}</span>`;
                    } else if (col.type === 'number') {
                         html = `<span class="font-mono font-medium text-slate-600">${Number(item[col.key]).toLocaleString()}</span>`;
                    } else {
                        html = `<span class="block truncate max-w-[200px]" title="${item[col.key]}">${item[col.key]}</span>`;
                    }
                    tr.innerHTML += `<td>${html}</td>`;
                });
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        function updateSheetStats(data) {
             const sumPBOQ = data.reduce((s,d)=>s+(parseFloat(d.pboq)||0),0);
             const sumFBOQ = data.reduce((s,d)=>s+(parseFloat(d.fboq)||0),0);
             document.getElementById('sheet-total-count').innerText = data.length;
             document.getElementById('sheet-wo-count').innerText = data.filter(d => d.workOrder).length;
             document.getElementById('sheet-pboq').innerText = `฿${formatCurrency(sumPBOQ)}`;
             document.getElementById('sheet-fboq').innerText = `฿${formatCurrency(sumFBOQ)}`;
             
             const statusCounts = {}; data.forEach(d => { let st = d.lastStatus || 'Unknown'; statusCounts[st] = (statusCounts[st]||0)+1; });
             const activeStatuses = Object.keys(statusCounts).filter(s => statusCounts[s] > 0);
             document.getElementById('sheet-status-breakdown').innerHTML = activeStatuses.length ? activeStatuses.map(s => {
                 const colorKey = Object.keys(STATUS_COLORS).find(k => k.toLowerCase() === s.toLowerCase());
                 const color = STATUS_COLORS[s] || STATUS_COLORS[colorKey] || '#cbd5e1';
                 return `<div class="flex items-center gap-2 min-w-max bg-white border border-slate-200 px-3 py-1.5 rounded-lg shadow-sm"><div class="w-2 h-2 rounded-full" style="background-color:${color}"></div><span class="text-[10px] font-bold text-slate-500 uppercase">${s}</span><span class="text-xs font-black text-slate-700">${statusCounts[s]}</span></div>`;
             }).join('') : '<span class="text-xs text-slate-400 pl-2">No active data</span>';
        }

        // ADD FORM
        async function handleFormSubmit(e) {
            e.preventDefault();
            const btn = e.submitter;
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="animate-spin w-4 h-4" data-lucide="loader-2"></i> Saving...`;
            lucide.createIcons();
            
            const newItem = {
                id: Date.now(),
                cctNo: document.getElementById('input-cct').value,
                year: document.getElementById('input-year').value,
                project: document.getElementById('input-type').value,
                projectName: document.getElementById('input-name').value,
                subRegion: document.getElementById('input-region').value,
                lastStatus: document.getElementById('input-status').value,
                workOrder: document.getElementById('input-wo').value,
                poNo: document.getElementById('input-po').value,
                pboq: document.getElementById('input-pboq').value || 0,
                fboq: document.getElementById('input-fboq').value || 0,
                googleDrive: 'Generating...',
                action: 'create'
            };
            
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(newItem), redirect: "follow", headers: { "Content-Type": "text/plain;charset=utf-8" } });
                const result = await response.json();
                if(result.status === 'success') {
                     newItem.googleDrive = result.driveLink;
                     globalData.unshift(newItem);
                     switchTab('list'); filterByType(null); renderTable(); e.target.reset();
                } else throw new Error(result.message);
            } catch(err) {
                 alert("Error saving: " + err.message);
            } finally {
                 btn.innerHTML = originalText; lucide.createIcons();
            }
        }
        
        function generateNextCCT() {
            if(!globalData.length) { document.getElementById('input-cct').value = 'CCT0001'; return; }
            const max = globalData.reduce((m, i) => { const match = i.cctNo.match(/(\d+)$/); return match ? Math.max(m, parseInt(match[1])) : m; }, 0);
            document.getElementById('input-cct').value = `CCT${String(max+1).padStart(4,'0')}`;
        }

        // MODAL
        function openProjectModal(t) {
            currentModalProjectType = t;
            const data = globalData.filter(d => (d.project||'').toLowerCase() === t.toLowerCase());
            document.getElementById('modal-title').innerText = t;
            
            // Modal Stats
            document.getElementById('modal-stats').innerHTML = `
                <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm text-center"><p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Total</p><p class="text-xl font-black text-slate-800">${data.length}</p></div>
                <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm text-center"><p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Budget</p><p class="text-xl font-black text-purple-600">฿${formatCurrency(data.reduce((s,d)=>s+(parseFloat(d.pboq)||0),0))}</p></div>
                <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm text-center"><p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Actual</p><p class="text-xl font-black text-pink-600">฿${formatCurrency(data.reduce((s,d)=>s+(parseFloat(d.fboq)||0),0))}</p></div>
                <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm text-center"><p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Work Orders</p><p class="text-xl font-black text-blue-600">${data.filter(d => d.workOrder).length}</p></div>
            `;
            
            // Modal Status Breakdown
            const statusCounts = {}; data.forEach(d => { let st = d.lastStatus||'Unknown'; statusCounts[st] = (statusCounts[st]||0)+1; });
            const activeStatuses = Object.keys(statusCounts).filter(s => statusCounts[s] > 0).sort((a,b) => statusCounts[b]-statusCounts[a]);
            document.getElementById('modal-status-bars').innerHTML = activeStatuses.length ? activeStatuses.map(s => {
                const colorKey = Object.keys(STATUS_COLORS).find(k => k.toLowerCase() === s.toLowerCase());
                const color = STATUS_COLORS[s] || STATUS_COLORS[colorKey] || '#cbd5e1';
                return `<div onclick="selectModalStatus('${s}')" class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded-lg cursor-pointer transition-colors group select-none"><div class="w-24 text-xs font-bold text-slate-600 truncate group-hover:text-slate-900">${s}</div><div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full rounded-full transition-all" style="width:${(statusCounts[s]/data.length)*100}%; background-color:${color}"></div></div><div class="w-6 text-right text-xs font-bold text-slate-700">${statusCounts[s]}</div></div>`;
            }).join('') : '<div class="text-center text-xs text-slate-400 py-4">No active data</div>';
            
            // Modal Filter
            const modalFilter = document.getElementById('modal-status-filter');
            modalFilter.innerHTML = '<option value="">All Statuses</option>';
            const uniqueStatuses = [...new Set(data.map(d => d.lastStatus))].sort();
            uniqueStatuses.forEach(s => { if(s) modalFilter.add(new Option(s, s)); });

            filterModalTable();
            document.getElementById('project-modal').classList.remove('hidden');
        }

        function selectModalStatus(status) {
            document.getElementById('modal-status-filter').value = status;
            filterModalTable();
        }

        function filterModalTable() {
            const status = document.getElementById('modal-status-filter').value;
            let data = globalData.filter(d => (d.project||'').toLowerCase() === currentModalProjectType.toLowerCase());
            if (status) data = data.filter(d => d.lastStatus === status);

            document.getElementById('modal-table-body').innerHTML = data.length ? data.map(d => {
                const colorKey = Object.keys(STATUS_COLORS).find(k => k.toLowerCase() === (d.lastStatus||'').toLowerCase());
                const color = STATUS_COLORS[d.lastStatus] || STATUS_COLORS[colorKey] || '#64748B';
                const driveHtml = d.googleDrive && d.googleDrive.startsWith('http') ? `<a href="${d.googleDrive}" target="_blank" class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition-colors"><i data-lucide="folder" class="w-4 h-4"></i></a>` : `<span class="text-slate-300">-</span>`;
                return `<tr class="border-b border-slate-50 hover:bg-slate-50 transition-colors"><td class="font-mono text-xs font-bold text-slate-500 py-3 px-4">${d.cctNo}</td><td class="font-bold text-xs text-slate-700 py-3 px-4 truncate max-w-[180px]">${d.projectName}</td><td class="text-center py-3 px-4">${driveHtml}</td><td class="text-right py-3 px-4"><span class="px-2 py-1 rounded text-[9px] font-bold uppercase tracking-wide border" style="color:${color}; background-color:${color}10; border-color:${color}20">${d.lastStatus}</span></td></tr>`;
            }).join('') : `<tr><td colspan="4" class="text-center py-8 text-slate-400 italic text-xs">No records found</td></tr>`;
            lucide.createIcons();
        }
        
        function closeProjectModal() { document.getElementById('project-modal').classList.add('hidden'); }

        // --- UTILS ---
        function switchTab(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            const target = id.startsWith('project-') ? 'view-list' : `view-${id}`;
            document.getElementById(target).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            const activeBtn = document.getElementById(`nav-${id.startsWith('project-') ? 'list' : id}`);
            if(activeBtn) activeBtn.classList.add('active');
            
            if(id === 'dashboard') { updateStats(); setTimeout(() => renderCharts(getDashboardData()), 100); }
            else if(id === 'list') { currentFilterType = null; updateListTitle('Master Data'); document.getElementById('sheet-summary-stats').classList.add('hidden'); document.getElementById('sheet-status-breakdown-container').classList.add('hidden'); renderTable(); }
            else if(id === 'add') { generateNextCCT(); }
            else if(id.startsWith('project-')) {
                currentFilterType = id.replace('project-', '');
                updateListTitle(`${currentFilterType} Projects`);
                document.getElementById('sheet-summary-stats').classList.remove('hidden');
                document.getElementById('sheet-status-breakdown-container').classList.remove('hidden');
                renderTable();
            }
        }
        function updateListTitle(t) { document.getElementById('list-title').innerHTML = t; }
        function initSidebar() {
            const c = document.getElementById('project-nav-container'); c.innerHTML = '';
            PROJECT_TYPES.forEach(t => { c.innerHTML += `<button onclick="switchTab('project-${t}'); toggleSidebar(false)" class="nav-item w-full text-sm"><i data-lucide="folder" class="w-4 h-4"></i> ${t}</button>`; });
        }
        function filterByType(t) { if(t) switchTab(`project-${t}`); else switchTab('list'); }
        function formatCurrency(v) { if(v>=1000000) return (v/1000000).toFixed(2)+'M'; if(v>=1000) return (v/1000).toFixed(1)+'K'; return v.toLocaleString(); }
        function initFormDropdowns() {
            const ts = document.getElementById('input-type'); PROJECT_TYPES.forEach(t=>ts.add(new Option(t,t)));
            const ss = document.getElementById('input-status'); STATUS_OPTIONS.forEach(s=>ss.add(new Option(s,s)));
            const ys = document.getElementById('input-year'); const yr = new Date().getFullYear(); [yr, yr+1].forEach(y => ys.add(new Option(y,y)));
        }
    </script>
</body>
</html>